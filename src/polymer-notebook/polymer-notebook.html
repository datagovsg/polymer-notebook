<link rel="import" href="../../bower_components/polymer/polymer.html">


<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="../../bower_components/prism-element/prism-highlighter.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="./ijavascript-panel.html">

<dom-module id="polymercliapp-app">
  <template>
    <style>
      :host {
        display: block;
        @apply(--layout-vertical);
        @apply(--layout-center);
      }

      paper-material{
        max-width: 900px;
        min-width: 600px;
        width: 90vh;
        margin: 5px;
      }

      paper-fab{
        position: fixed;
        bottom: 10px;
        right: 10px;
      }

    </style>
    <h2>Polymer Notebook</h2>

    <prism-highlighter></prism-highlighter>

    <template is="dom-repeat" items="[[panels]]">
      <paper-material>
        <ijavascript-panel
          id="{{item.id}}"
          codes="{{item.code}}"
          markdown="{{item.md}}"
          results="{{item.res}}"></ijavascript-panel>
      </paper-material>
    </template>

    <paper-fab icon="add" on-tap="_insertPanel"></paper-fab>


    <paper-toast text="[[msg]]"></paper-toast>

  </template>

  <script>
    Polymer({

      is: 'polymercliapp-app',

      properties: {

        panels:{
          type: Array,
          value: function(){return [{id:0,code:'',md:'',res:''}];}
        },
        msg:{
          type: String
        },
        _id: {
          type: Number,
          value: 0
        },
        _hasWorker: {
          type: Boolean
        },
        _worker: {
          type: Object
        }
      },

      listeners: {
        'eval': '_eval'
      },

      created: function(){
        this._hasWorker = window.Worker && true;
      },

      ready: function(){
        this._hasWorker && this._initWorker();
        this.msg = this._hasWorker ? "Webworker started!":"Your browser does not support Webworkers!";
      },

      _insertPanel: function(){
        var id = ++this._id;
        this.push('panels',{id:id,code:'',md:'',res:''})
      },

      _initWorker: function(){
        var self = this;
        this._worker = new Worker("webworker.js");
        this._worker.onmessage = function(e) {
          var res = e.data;
          //self.panels[res.id].res = res.res.toString();
          self.set('panels.'+res.id+'.res',res.res.toString());
        }
      },

      _eval: function(e,msg){
        this._worker.postMessage(msg);
      }

    });
  </script>
</dom-module>
